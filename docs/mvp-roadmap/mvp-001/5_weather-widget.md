# MVP-001 天気ウィジェット調整仕様（ドラフト）

## 背景
- `WeatherWidget` はホームマップ上に固定配置され、位置情報を取得して Open-Meteo API から天気データを取得する。
- 現状は許可拒否や通信失敗時に `Alert.alert` を出すだけで、ウィジェット本体がローディング表示のまま止まるケースがある。
- `MVP-001` ではマップのレイアウトを調整するタイミングで、ウィジェットの状態表示・配置も整え、エラー時でも UI が崩れないようにする。

## 現状の挙動整理
- マウント直後に `fetchWeatherData()` を実行し、即座に `Location.requestForegroundPermissionsAsync()` で権限を求める。
- 許可されれば `getCurrentPositionAsync()` で現在地を取得し、Open-Meteo の 1 時間ごとの予報を24件取得している。
- 取得中はスピナー（FontAwesome `spinner`）を表示。取得後は天気アイコン＋気温、ボタンタップでモーダルを開く。
- 位置情報拒否や API 失敗時は `Alert.alert()` でダイアログを表示し、ウィジェットはローディング状態のまま。
- レイアウトは `position: "absolute"; top: 120; left: 16` などで固定。Safe Area や他 UI との重なりを考慮していない。

## 改善方針
### 1. 状態管理を明示し、UIをステータス別に切り替える
- `status` を `"loading" | "ready" | "denied" | "error"` の4状態で持ち、ウィジェットの表示を分岐する。
  - `loading`: 権限待ち／取得中 → スピナーアイコン表示。
  - `denied`: 位置情報権限なし → ロックアイコン＋「設定を開く」ボタンを表示。
  - `error`: 通信失敗 → Wi-Fi オフ風アイコン＋「再読み込み」ボタンを表示。
  - `ready`: 正常にデータ取得 → 天気アイコン＋気温表示。
- `Alert.alert` は必要なら補助的に使う（例: 初回拒否時の通知）が、ウィジェット自身も状態に応じた表示へ切り替えて情報を残す。

### 2. 権限拒否時の導線
- `denied` 状態ではロックアイコンと案内文（例: "位置情報が必要です"）。
- 「設定を開く」ボタンで `Linking.openSettings()` を呼び、端末の設定アプリに誘導する。
- フォールバックとして `mapsConfig.defaultCenter` の座標で天気を取得するか、もしくは「天気情報を表示できません」と明示する。初期実装では後者を採用。

### 3. 通信失敗時のリトライ
- `error` 状態では Wi-Fi オフアイコンと「再読み込み」ボタンを表示。押下で `fetchWeatherData()` を再実行。
- ローディング中は何度でも実行できるよう `loading` と `error` を排他的に扱う。

### 4. レイアウトと Safe Area 対応
- `useSafeAreaInsets()` を利用し、`top: insets.top + 12` のように端末ごとの安全領域を基準に配置。
- ウィジェットは左上固定（右側の再フォーカスボタンと干渉しない）。`position` props は `"left" | "right"` から `"top-left" | "top-right"` などへ見直すか、MVPでは `left` 固定とする。
- `zIndex` をマップ上の他 UI（再フォーカスボタン、検索バー）と調整し、重なり順を定義する。

### 5. 表示のローカライズと一覧改善
- 気温は `Math.round(temp)` の結果に `"℃"` を付ける。
- 天気コード→日本語ラベルのマッピングを用意し、モーダル内にも表示できるようにする。
- モーダル内のリストは `FlatList` で実装し、`keyExtractor` に `item.time` を使って再レンダリングを安定化。

### 6. 位置情報状態との連携
- 現状は `WeatherWidget` 内で権限リクエストと現在地取得を完結させている。
- 今後 `MapTop` 側の位置情報状態と統合する場合は、`MapTop` から権限状態や座標を受け取り再利用する。

## 実装状況メモ（2025-10-06）
- `status` と `weather` オブジェクトで状態管理を整理し、権限拒否・通信失敗時の導線をウィジェット内に表示するよう変更。
- Safe Area に合わせた位置調整を導入したが、検索ヘッダーとの重なりがあるため Issue #36 で追跡中。
- モーダル内の一覧表示を `ScrollView` から `FlatList` に置き換え、仮想化レンダリングを実現。
- `data={weather?.hourly.slice(0, 24) ?? []}` で24時間分に明示的に制限し、パフォーマンスと表示件数を保証。
- 温度表示を `℃` に統一。

## UX観点の留意点
- ダイアログ依存を減らし、ウィジェット内で状態が完結するようにする。
- エラーや拒否が続いてもボタンが一瞬で戻らないよう、ユーザーが認識しやすいアイコンと文言を用意する。
- 「再読み込み」や「設定を開く」の操作結果を `status` へ反映し、ユーザーが次に何をすればよいかを明確にする。

## QAチェック項目（`MVP-008` 連携）
- 権限許可 → 天気が表示される。
- 権限拒否 → ロック表示＋設定誘導が表示される。
- ネットワークエラー → Wi-Fiオフ表示＋再読み込みボタンが動作する。
- モーダル表示 → 24時間分のデータがスクロールできる、閉じたあとウィジェット位置が変わらない。
